<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.thinkjoy.gaokao360.dao.ex.IUniversityMajorExDAO">
    <!--
    insert
    update
    updateNull
    deleteById
    deleteByCondition
    deleteByProperty
    fetch
    findOne
    findList
    findAll
    queryPage
    like
    queryList
    queryOne
    count
    selectMaxId
    updateOrSave
    selectOne
    selectList
    -->

    <sql id="Base_Column_List">
        id as id ,
        universityId as universityId ,
        universityName as universityName ,
        majorId as majorId ,
        majorName as majorName ,
        majorType as majorType ,
        majorSubject as majorSubject ,
        educationLevel as educationLevel ,
        gainDegree as gainDegree ,
        majorRank as majorRank ,
        createDate as createDate ,
        creator as creator ,
        lastModDate as lastModDate ,
        lastModifier as lastModifier ,
        isDelete as isDelete
    </sql>



    <select id="fetch" parameterType="java.lang.Long" resultType="cn.thinkjoy.gaokao360.dto.UniversityMajorDTO">
        SELECT
        id,
        universityId,
        universityName,
        majorId,
        majorName,
        educationLevel,
        (SELECT name FROM zgk_data_dict WHERE type='EDULEVEL' and dictId=educationLevel limit 1) as educationLevelName,
        majorRank,
        salaryRank,
        jobRank,
        majorFeature
        FROM zgk_university_major
        <trim prefix="WHERE" prefixOverrides="AND | OR">
            AND id = #{id}
        </trim>
    </select>

    <select id="findOne" parameterType="java.util.Map" resultType="UniversityMajor">
        SELECT
        <include refid="Base_Column_List" />
        FROM zgk_university_major WHERE
        ${property} = #{value}
        <if test="orderBy!=null">
            ORDER BY ${orderBy} ${sortBy}
        </if>
        LIMIT 0,1
    </select>

    <select id="findList" parameterType="java.util.Map" resultType="UniversityMajor">
        SELECT
        <include refid="Base_Column_List" />
        FROM zgk_university_major WHERE
        ${property} = #{value}
        <if test="orderBy!=null">
            ORDER BY ${orderBy} ${sortBy}
        </if>
    </select>

    <select id="queryPage" resultType="cn.thinkjoy.gaokao360.dto.UniversityMajorDTO">
        SELECT
        id,
        universityId,
        universityName,
        majorId,
        majorName,
        educationLevel,
        (SELECT name FROM zgk_data_dict WHERE type='EDULEVEL' and dictId=educationLevel limit 1) as educationLevelName,
        majorRank,
        salaryRank,
        jobRank,
        majorFeature
        FROM zgk_university_major
        <where>
            <if test="condition.whereSql != null">
                and id in (#{condition.whereSql})
            </if>
            <if test="condition.educationLevel!=null">
                and    educationLevel =  #{condition.educationLevel.data}
            </if>
            <if test="condition.keywordSearch!=null">
                and   majorName  like CONCAT('%',#{condition.keywordSearch.data},'%')
            </if>
        </where>
            ORDER BY id desc
        <if test="offset != null">
            limit ${offset}, ${rows}
        </if>
    </select>

    <select id="count" resultType="java.lang.Integer">
        SELECT count(id) FROM zgk_university_major
        <where>
            <if test="whereSql != null">
                and id in (#{whereSql})
            </if>
            <if test="educationLevel!=null">
                and    educationLevel =  #{educationLevel.data}
            </if>
            <if test="keywordSearch!=null">
                and    majorName like CONCAT('%',#{keywordSearch.data},'%')
            </if>
        </where>
    </select>



    <select id="selectMaxId" resultType="java.lang.Long">
        SELECT
        MAX(id)
        FROM zgk_university_major
    </select>

    <select id="getMajorOpenUniversityList" parameterType="java.util.Map" resultType="UniversityDTO">
        SELECT
            university.id as id ,
            university.name as name ,
            university.subjection as subjection ,
            university.photo_url as photoUrl ,
            university.property as property ,
            leveldict.name as levelName,
            university.rank as rank ,
            typedict.name as typeName,
            province.name as province,
            university.lastModifier as lastModifier
        FROM
            zgk_university university
        LEFT JOIN zgk_province province ON province.id = university.areaid
        LEFT JOIN zgk_data_dict typedict ON typedict.dictId=university.type AND typedict.type='UNIVERSITY_TYPE'
        LEFT JOIN zgk_data_dict leveldict ON leveldict.dictId = university.educationLevel AND leveldict.type='EDULEVEL'
        where
            university.id in (select universityId from zgk_university_major mm where mm.majorId= #{condition.majorId} )
        ORDER BY university.lastModifier DESC
        <if test="offset != null">
            limit ${offset}, ${rows}
        </if>
    </select>


    <insert id="insertUniversityMajor">
        INSERT INTO zgk_university_major (
        universityId,
        universityName,
        majorName,
        educationLevel,
        salaryRank,
        jobRank,
        majorFeature,
        gainDegree,
        majorId,
        majorRank,
        majorType,
        majorSubject,
        createDate,
        creator,
        lastModDate,
        lastModifier,
        isDelete
        ) VALUES (
        (SELECT id FROM zgk_university WHERE name =  #{universityName} limit 1),
        #{universityName},
        #{majorName},
        #{educationLevel},
        #{salaryRank},
        #{jobRank},
        #{majorFeature},
        #{gainDegree},
        (SELECT aa.id FROM zgk_major aa INNER JOIN zgk_majored_category bb ON bb.id=aa.discipline_categories WHERE major_name =  #{majorName} AND bb.parentId=#{educationLevel} limit 1),
        #{majorRank},
        #{majorType},
        #{majorSubject},
        #{createDate},
        #{creator},
        #{lastModDate},
        #{lastModifier},
        #{isDelete}
        )
        <selectKey resultType="java.lang.Long" keyProperty="id">
            SELECT LAST_INSERT_ID() AS ID
        </selectKey>
    </insert>

    <!-- 更新 -->
    <update id="updateUniversityMajor">
        UPDATE zgk_university_major
        <trim prefix="SET" suffixOverrides=",">
            <if test="universityId!=null">
                universityId = (SELECT id FROM zgk_university WHERE name =  #{universityName} limit 1),
            </if>
            <if test="universityName!=null">
                universityName = #{universityName},
            </if>
            <if test="majorName!=null">
                majorName = #{majorName},
            </if>
            <if test="educationLevel!=null">
                educationLevel = #{educationLevel},
            </if>
            <if test="salaryRank!=null">
                salaryRank = #{salaryRank},
            </if>
            <if test="jobRank!=null">
                jobRank = #{jobRank},
            </if>
            <if test="majorFeature!=null">
                majorFeature = #{majorFeature},
            </if>
            <if test="gainDegree!=null">
                gainDegree = #{gainDegree},
            </if>
            <if test="majorId!=null">
                majorId = (SELECT aa.id FROM zgk_major aa INNER JOIN zgk_majored_category bb ON bb.id=aa.discipline_categories WHERE major_name =  #{majorName} AND bb.parentId=#{educationLevel} limit 1),                ,
            </if>
            <if test="majorRank!=null">
                majorRank = #{majorRank},
            </if>
            <if test="majorType!=null">
                majorType = #{majorType},
            </if>
            <if test="majorSubject!=null">
                majorSubject = #{majorSubject},
            </if>
            <if test="createDate!=null">
                createDate = #{createDate},
            </if>
            <if test="creator!=null">
                creator = #{creator},
            </if>
            <if test="lastModDate!=null">
                lastModDate = #{lastModDate},
            </if>
            <if test="lastModifier!=null">
                lastModifier = #{lastModifier},
            </if>
            <if test="isDelete!=null">
                isDelete = #{isDelete},
            </if>
        </trim>
        WHERE
        id = #{id}
    </update>

    <!-- 按Id删除 -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM zgk_university_major
        <trim prefix="WHERE" prefixOverrides="AND | OR">
            AND id = #{id}
        </trim>
    </delete>

</mapper>

